---
title: "Are rhizobia under selection to cheat?"
author: "Megan Frederickson"
date: "`r format(Sys.Date())`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fitness conflict or fitness alignment?

This repository re-analyzes the data in: 

Gano-Cohen KA, Wendlandt CE, Stokes PJ, Blanton MA, Quides KW, Zomorrodian A, Adinata ES, Sachs JL (2019) Interspecific conflict and the evolution of ineffective rhizobia. Ecology Letters. https://doi.org/10.1111/ele.13247

The authors make the case that in their legume-rhizobium study system, the rhizobia are selected to cheat. In other words, they report a negative correlation between legume and rhizobium fitnesses.

Here, I re-analyze their data using a standard genetic selection analysis approach, in which relativized fitness is regressed against standardized family-mean trait values. 

First we need to load some nifty R packages.

```{r Load packages, message=FALSE, warning=FALSE}

#Load useful packages
library(tidyverse) #includes ggplot2, dplyr, readr, stringr
library(cowplot)
library(car)
library(glmm)
library(nlme)
library(lme4)
library(emmeans)

```

I downloaded the data from Dryad on April 16, 2019. The citation for the data package is:

Gano-Cohen KA, Wendlandt CE, Stokes PJ, Blanton MA, Quides KW, Zomorrodian A, Adinata ES, Sachs JL (2019) Data from: Interspecific conflict and the evolution of ineffective rhizobia. Dryad Digital Repository. https://doi.org/10.5061/dryad.cr65269

```{r Download data, message=FALSE, warning=FALSE}

data <- read_csv("Table_S4.csv")

#Make sure factors are factors and numbers are numbers

data$Strain <- as.factor(data$Strain)
data$`Host Line` <- as.factor(data$`Host Line`)
data$Population <- as.factor(data$Population)
data$`Total nodules` <- as.numeric(data$`Total nodules`)
data$`Mean individual  nodule biomass (mg)` <- as.numeric(data$`Mean individual  nodule biomass (mg)`)
data$`Shoots mass (g)` <- as.numeric(data$`Shoots mass (g)`)
data$`Roots mass (g)` <- as.numeric(data$`Roots mass (g)`)
data$`Relative Growth` <- as.numeric(data$`Relative Growth`)
data$Block <- as.factor(data$Block)

```

# Calculate genotype means

The dataset has two measures of plant fitness and four measures of rhizobium fitness. The two measures of plant fitness are total plant biomass (i.e., shoot plus root mass) and relative growth rate (i.e., inoculated plant biomass divided by control plant biomass, hereafter "RGR"). The four measures of rhizobium fitness are total number of nodules, mean nodule mass, and two genotypic frequencies, which the authors abbreviate CHR and SI. See original paper for details. 

First, we need to calculate the appropriate strain means for each variable. I did this using the emmeans package, which calculates estimated marginal means from a linear mixed model. I have tried to stick as close as possible to the analysis presented in the paper, which states that "all effects were coded as fixed except block, which was treated as a random effect" and that variables were log-transformed as needed to improve normality. I also calculated strain means only on data from sympatric hosts, again following the approach in the paper.

```{r Genotype means, message=FALSE, warning=FALSE}

#Clean up dataset a bit
data <- subset(data, Strain != "control") #Exclude control, uninoculated plants
data <- subset(data, `Total nodules` > 0) #Exclude inoculated plants that did not form nodules, as these are cases where the inoculation may have failed
data$log_nodules <- log(data$`Total nodules`) #Log transform as needed, as per paper
data$log_mean_nod_biomass <- log(data$`Mean individual  nodule biomass (mg)`) #Log transform as needed, as per paper
data$plant_biomass <- data$`Shoots mass (g)` + data$`Roots mass (g)` #Combine shoot and root mass into one measure of plant biomass

#Divide into sympatric and universal hosts, as per paper
data_sym <- subset(data, `Host Line` != "A. heermannii" & `Host Line` != "UnH: Cla12.04" & `Host Line` != "UnL: Anz13.04")
data_uni <- subset(data, `Host Line` == "A. heermannii" | `Host Line` == "UnH: Cla12.04" | `Host Line` == "UnL: Anz13.04")

#Fit models 
lmm1 <- lmer(log_nodules~Population + Strain + `Host Line` + (1|Block), data=data_sym) #Total nodule number model
#plot(lmm1)
#summary(lmm1)
Anova(lmm1, type=3)
df.means <- as.data.frame(emmeans(lmm1, "Strain")) #Extract line means and save them to new dataframe
colnames(df.means) <- c("Strain", "Population", "tot_nod_lsmean", "tot_nod_SE", "tot_nod_df", "tot_nod_lowCL", "tot_nod_highCL") #Fix column names

lmm2 <- lmer(log_mean_nod_biomass~Population + Strain + `Host Line` + (1|Block), data=data_sym) #Mean nodule mass model
#plot(lmm2)
#summary(lmm2)
Anova(lmm2, type=3)
tmp <- as.data.frame(emmeans(lmm2, "Strain")) #Extract line means and add them to the dataframe
colnames(tmp) <- c("Strain", "Population", "nod_mass_lsmean", "nod_mass_SE", "nod_mass_df", "nod_mass_lowCL", "nod_mass_highCL")
df.means <- cbind(df.means, tmp[,3:7])

lmm3 <- lmer(plant_biomass~Population + Strain  + `Host Line` + (1|Block), data=data_sym) #Plant biomass model
#plot(lmm3)
#summary(lmm3)
Anova(lmm3, type=3)

tmp <- as.data.frame(emmeans(lmm3, "Strain")) #Extract line means and add them to the dataframe
colnames(tmp) <- c("Strain", "Population", "plant_biomass_lsmean", "plant_biomass_SE", "plant_biomass_df", "plant_biomass_lowCL", "plant_biomass_highCL")
df.means <- cbind(df.means, tmp[,3:7])

lmm4 <- lmer(log(`Relative Growth`)~Population + Strain  + `Host Line` + (1|Block), data=data_sym) #Relative growth rate, log-transformed as per the paper, but note this generates NAs because there are negative values
#plot(lmm4)
#summary(lmm4)
Anova(lmm4, type=3)
tmp <- as.data.frame(emmeans(lmm4, "Strain")) #Extract line means and add them to the dataframe
colnames(tmp) <- c("Strain", "Population", "RGR_lsmean", "RGR_SE", "RGR_df", "RGR_lowCL", "RGR_highCL")
df.means <- cbind(df.means, tmp[,3:7])

#Add CHR and SI values for each isolate; they are identical for all replicates of each isolate, so no need to model them
tmp <- data_sym %>% group_by(Strain) %>% summarize(CHR = mean(`CHR local abundance`), SI = mean(`SI local abunance`))
df.means <- merge(df.means, tmp, by="Strain")

#Calculate means and SDs for each fitness/trait measure for each population separately
tmp <- df.means %>% group_by(Population) %>% summarize(
  pop_mean_tot_nod=mean(tot_nod_lsmean), 
  pop_sd_tot_nod=sd(tot_nod_lsmean),
  pop_mean_nod_mass=mean(nod_mass_lsmean),
  pop_sd_nod_mass=sd(nod_mass_lsmean),
  pop_mean_CHR=mean(CHR),
  pop_mean_SI=mean(SI),
  pop_mean_plant_biomass=mean(plant_biomass_lsmean),
  pop_sd_plant_biomass=sd(plant_biomass_lsmean),
  pop_mean_RGR=mean(RGR_lsmean),
  pop_sd_RGR=sd(RGR_lsmean)
  )
df.means <- merge(df.means, tmp, by="Population") #Merge data frames

#Relativize fitness by dividing by the mean fitness
df.means$tot_nod_std <- df.means$tot_nod_lsmean/df.means$pop_mean_tot_nod
df.means$nod_mass_std <- df.means$nod_mass_lsmean/df.means$pop_mean_nod_mass
df.means$CHR_std <- df.means$CHR/df.means$pop_mean_CHR
df.means$SI_std <- df.means$SI/df.means$pop_mean_SI

#Standardize traits by subtracting the population mean and dividing by the population standard deviation
df.means$plant_biomass_std <- (df.means$plant_biomass_lsmean - df.means$pop_mean_plant_biomass)/df.means$pop_sd_plant_biomass
df.means$RGR_std <- (df.means$RGR_lsmean - df.means$pop_mean_RGR)/df.means$pop_sd_RGR

```

# Estimate selection gradients

Next, I adopt standard genetic selection analyses to estimate selection gradients by regressing relativized fitness against standardized trait values. I estimated eight selection gradients, because there are four fitness measures (nodule number, nodule mass, CHR, and SI) and two traits (plant biomass and RGR) in the paper. 

```{r Estimate selection gradients, message=FALSE, warning=FALSE}

#Total nodules and plant biomass

lm1 <- lm(tot_nod_std~plant_biomass_std, data=df.means) #Model
summary(lm1)
S1 <- paste0("S = ", round(summary(lm1)$coefficients[2,1], 3))
pval1 <- round(summary(lm1)$coefficients[2,4],3)
pval1 <- ifelse(pval1 <= 0.05, paste0("p = ", pval1), "ns")
S1 <- paste0(S1, ", ", pval1)

p1 <- ggplot(data=df.means, aes(y=tot_nod_std, x=plant_biomass_std))+
      geom_point()+
      geom_smooth(method="lm", se=TRUE)+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3, check_overlap=TRUE)+
      ylab("Nodule number")+
      xlab("Plant biomass")

#ggsave("fitness_correlation.png", p1, dpi=600)

#Nodule mass and plant biomass

lm2 <- lm(nod_mass_std~plant_biomass_std, data=df.means) #Model
summary(lm2)
S2 <- paste0("S = ", round(summary(lm2)$coefficients[2,1], 3))
pval2 <- round(summary(lm2)$coefficients[2,4],3)
pval2 <- ifelse(pval2 <= 0.05, paste0("p = ", pval2), "ns")
S2 <- paste0(S2, ", ", pval2)

p2 <- ggplot(data=df.means, aes(y=nod_mass_std, x=plant_biomass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("Nodule mass")+
      xlab("Plant biomass")

#CHR and plant biomass

lm3 <- lm(CHR_std~plant_biomass_std, data=df.means) #Model
summary(lm3)
S3 <- paste0("S = ", round(summary(lm3)$coefficients[2,1], 3))
pval3 <- round(summary(lm3)$coefficients[2,4],3)
pval3 <- ifelse(pval3 <= 0.05, paste0("p = ", pval3), "ns")
S3 <- paste0(S3, ", ", pval3)

p3 <- ggplot(data=df.means, aes(y=CHR_std, x=plant_biomass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("CHR")+
      xlab("Plant biomass")+
      guides(color=FALSE)

#SI and plant biomass

lm4 <- lm(SI_std~plant_biomass_std, data=df.means) #Model
summary(lm4)
S4 <- paste0("S = ", round(summary(lm4)$coefficients[2,1], 3))
pval4 <- round(summary(lm4)$coefficients[2,4],3)
pval4 <- ifelse(pval4 <= 0.05, paste0("p = ", pval4), "ns")
S4 <- paste0(S4, ", ", pval4)

p4 <- ggplot(data=df.means, aes(y=SI_std, x=plant_biomass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("SI")+
      xlab("Plant biomass")

#Total nodules and RGR

lm5 <- lm(tot_nod_std~RGR_std, data=df.means) #Model
summary(lm5)
S5 <- paste0("S = ", round(summary(lm5)$coefficients[2,1], 3))
pval5 <- round(summary(lm5)$coefficients[2,4],3)
pval5 <- ifelse(pval5 <= 0.05, paste0("p = ", pval5), "ns")
S5 <- paste0(S5, ", ", pval5)

p5 <- ggplot(data=df.means, aes(y=tot_nod_std, x=RGR_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("Nodule number")+
      xlab("RGR")

#Nodule mass and RGR

lm6 <- lm(nod_mass_std~RGR_std, data=df.means) #Model
summary(lm6)
S6 <- paste0("S = ", round(summary(lm6)$coefficients[2,1], 3))
pval6 <- round(summary(lm6)$coefficients[2,4],3)
pval6 <- ifelse(pval6 <= 0.05, paste0("p = ", pval6), "ns")
S6 <- paste0(S6, ", ", pval6)

p6 <- ggplot(data=df.means, aes(y=nod_mass_std, x=RGR_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("Nodule mass")+
      xlab("RGR")

#CHR and RGR

lm7 <- lm(CHR_std~RGR_std, data=df.means) #Model
summary(lm7)
S7 <- paste0("S = ", round(summary(lm7)$coefficients[2,1], 3))
pval7 <- round(summary(lm7)$coefficients[2,4],3)
pval7 <- ifelse(pval7 <= 0.05, paste0("p = ", pval7), "ns")
S7 <- paste0(S7, ", ", pval7)

p7 <- ggplot(data=df.means, aes(y=CHR_std, x=RGR_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("CHR")+
      xlab("RGR")

#SI and RGR

lm8 <- lm(SI_std~RGR_std, data=df.means) #Model
summary(lm8)
S8 <- paste0("S = ", round(summary(lm8)$coefficients[2,1], 3))
pval8 <- round(summary(lm8)$coefficients[2,4],3)
pval8 <- ifelse(pval8 <= 0.05, paste0("p = ", pval8), "ns")
S8 <- paste0(S8, ", ", pval8)

p8 <- ggplot(data=df.means, aes(y=SI_std, x=RGR_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE, linetype="dashed")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      ylab("SI")+
      xlab("RGR")
```

# Selection on symbiont quality, measured as RGR

After standardizing relative growth within each population and relativizing all four bacterial fitness measures, there is no significant selection on symbiont quality when it is measured as RGR, as in the paper. Dashed lines show non-significant regressions.

```{r Visualize selection gradients, using RGR, warning=FALSE, message=FALSE, dpi=600, fig.height=6}

plot_grid(p5,p6,p7,p8, labels=c(S5, S6, S7, S8), hjust = c(-1.7, -1, -1, -1), scale = 0.9)

```

# Selection on symbiont quality, measured as plant biomass

Performing the same analysis but measuring symbiont quality using plant biomass, in the more traditional fashion, shows only one statistically significant selection gradient: the regression of nodule number on plant biomass. And the relationship is positive, suggesting fitness alignment, not conflict, between partners. Solid lines show significant selection gradients. Dashed lines show non-signficiant selection gradients. 

```{r Visualize selection gradients, using plant biomass, message=FALSE, dpi=600, fig.height=6, warning=FALSE}

plot_grid(p1,p2,p3,p4, labels=c(S1, S2, S3, S4), hjust = c(-0.8, -1, -1, -1), scale=0.9)
          
```

# Why do different fitness measures give different answers?


```{r Correlations among fitness proxies, , message=FALSE, dpi=600, fig.height=6, warning=FALSE}

#Correlations among rhizobium fitness proxies
lm9 <- lm(SI_std~CHR_std, data=df.means) #Model
summary(lm9)

p9 <- ggplot(data=df.means, aes(y=SI_std, x=CHR_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      xlab("CHR")+
      ylab("SI")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)

lm10 <- lm(SI_std~nod_mass_std, data=df.means) #Model
summary(lm10)

p10 <- ggplot(data=df.means, aes(y=SI_std, x=nod_mass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      xlab("Nodule mass")+
      ylab("SI")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)

lm11 <- lm(SI_std~tot_nod_std, data=df.means) #Model
summary(lm11)

p11 <- ggplot(data=df.means, aes(y=SI_std, x=tot_nod_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      xlab("Nodule number")+
      ylab("SI")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)

lm12 <- lm(CHR_std~nod_mass_std, data=df.means) #Model
summary(lm12)

p12 <- ggplot(data=df.means, aes(y=CHR_std, x=nod_mass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      xlab("Nodule mass")+
      ylab("CHR")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)

lm13 <- lm(CHR_std~tot_nod_std, data=df.means) #Model
summary(lm13)

p13 <- ggplot(data=df.means, aes(y=CHR_std, x=tot_nod_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      xlab("Nodule number")+
      ylab("CHR")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)

lm14 <- lm(tot_nod_std~nod_mass_std, data=df.means) #Model
summary(lm14)

p14 <- ggplot(data=df.means, aes(y=tot_nod_std, x=nod_mass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      xlab("Nodule mass")+
      ylab("Nodule number")+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)


plot_grid(p9, p10, p11, p12, p13, p14)

#Corrlation between plant fitness proxies

lm15 <- lm(RGR_std~plant_biomass_std, data=df.means)
summary(lm15)

p15 <- ggplot(data=df.means, aes(y=RGR_std, x=plant_biomass_std))+
      geom_point()+
      geom_smooth(method="lm", se=FALSE)+
      geom_text(aes(label=Strain),hjust=0, vjust=0, size=3)+
      xlab("Plant biomass")+
      ylab("RGR")
p15

```

